<html>

<head>
    <title>Ready to Play</title>
    <script src="../../ApiHandler.js"></script>
</head>
<style>
    div {
        font-family: Verdana;
    }

    button {
        border-radius: 10px;
    }

    .button1 {
        background-color: lime;
        /*CSS design for the colours of buttons and input box */
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
    }

    .button2 {
        background-color: yellowgreen;
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
    }

    .button3 {
        background-color: lightcoral;
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
    }

    .button4 {
        background-color: Grey;
        border: none;
        color: black;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
    }

    .center {
        margin: auto;
        width: 35%;
        padding: 130px;
    }

    .button1:hover {
        background-color: #4CAF50;
    }

    .button2:hover {
        background-color: yellow;
    }

    .button3:hover {
        background-color: lightsalmon;
    }

    .button4:hover {
        background-color: wheat;
    }

    input[type=text],
    select {
        width: 100%;
        padding: 12px 20px;
        margin: 8px 0;
        display: inline-block;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }


    .row {
        display: flex;
    }

    /* Create two equal columns that sits next to each other */
    .column {
        flex: 75%;
        padding: 10px;
        height: 100vh;
        /* Should be removed. Only for demonstration */
    }

    #leftPanel {
        flex: 25%;
        padding: 10px;
        height: 100vh;
    }

    .header {
        background-color: #6499E9;
        flex: 100%;
        height: 40px
    }

    #hintPanel {
        font-size: 2rem;
        font-family: Verdana;
    }

    .roundBox {
        background-color: #9EDDFF;
        border-radius: 5px;
        width: 80%;
        min-height: 5rem;
        font-size: 2rem;
    }

    #controlPanel {
        display: flex;
        justify-content: center;
    }

    #word {
        width: 50%;
    }
</style>

<body>
    <div id="container">

        <!-- <div class="center">
            <h1>Wordtopia</h1>
        </div> -->

        <div class="header">
        </div>

        <div class="row">
            <div id="leftPanel" class="column" style="background-color: #BEFFF7;">
                <div>
                    <div class="roundBox">
                        <p>Countdown: <span id="countdown"></span></p><!--Experimental timer 60s can be adjusted-->
                    </div>
                    <div class="roundBox">
                        <p id="categoryLabel">Category: </p>
                    </div>
                    <div class="roundBox">
                        <p id="roundboard">Round: </p>
                    </div>
                    <div class="roundBox">
                        <p id="turnboard">Turns left: </p>
                    </div>
                    <div class="roundBox">
                        <p id="scoreboard">Your Score: </p>
                    </div>
                    <div class="roundBox">
                        <p id="computerScoreboard">PC Score: </p>
                    </div>
                </div>
            </div>
            <div class="column" id="center" style="background-color: #BEFFF7;">
                <div style="display: flex; justify-content: center ;">
                    <p id="hintPanel">Loading Word and Hint. Please wait</p>
                </div>
                <!-- <div style="display: flex; justify-content: center ;">
                    <button onclick="countdown()">Start Timer</button>
                </div> -->
                <div style="display: flex; justify-content: center ; margin: 1rem;">
                    <input type="text" id="wordInput" name="word" placeholder="Guess the Answer"><br><br>
                </div>
                <div id="controlPanel" class="input" style="display: none;">
                    <button class="button1" onclick="wordChecker()">Submit</button> <!--Buttons for game operations-->
                    <button class="button2" onclick="passTurn()">Pass</button>
                    <button class="button3" onclick="resetScore()">Reset</button>
                    <button class="button4" onclick="endCount()">Give Up</button>
                </div>
            </div>
        </div>
    </div>


</body>
<script>

    var userScore = 0;
    var computerScore = 0;
    var difficulty = "Lupos"; //temp
    var category = "food"; //temp 
    var originalRounds = 2 //fromStrorage
    var rounds = 1;
    var originalTurns = 3 //turns based on difficulty //fromStorage
    var turns = originalTurns;
    var numberOfHints = 0 ; //determines how manu hints are created //fromStorage
    var hints = []
    var hintNo = 1; //used to flip between which hints to display.

    //this function initializes the round, by getting a new word and generating hints
    function initWordRound(category, difficulty) {
        console.log("Player chooses category: " + category)
        console.log("Player chooses difficulty: " + difficulty)
        document.getElementById("roundboard").innerHTML = "Round: " + rounds + "/" + originalRounds;
        document.getElementById("categoryLabel").innerHTML = "Category: ";
        document.getElementById("turnboard").innerHTML = "Turns Left: " + turns;
        apiCommunicator(category)

        updateData();
    }


    //this updates the scoreboard based on the winner of the last round
    function updateData() {
        document.getElementById("scoreboard").innerHTML = "Your Score: " + userScore;
        document.getElementById("computerScoreboard").innerHTML = "PC Score: " + computerScore;
        document.getElementById("categoryLabel").innerHTML = "Category: " + category;
        document.getElementById("roundboard").innerHTML = "Round: " + rounds + "/" + originalRounds;
        document.getElementById("turnboard").innerHTML = "Turns Left: " + turns;
    }

    //resets the score back to zero when game is played again
    function resetScore() {
        userScore = 0;
        computerScore = 0;
        rounds = 1;
        updateData();
    }

    //adds a score based on the guessed word
    function addScore(isWinner) {
        if (isWinner) {
            userScore += 1;
        } else {
            computerScore += 1;
        }
        updateData();
    }

    //pass button
    function passTurn() {
        addScore(false)
        document.getElementById("hintPanel").innerHTML = "Surrendered!" ; updateData();
        apiCommunicator(category)


    }

    const setResultsData = () => {
        sessionStorage.setItem('resultsData', JSON.stringify({
            category: 'Animal',
            word: 'input',
            round: 2,
            duration: '2:00',
            winner: 'Player 1',
            matchType: 'Rematch'
        }))
    };

    function countdown() {
        var seconds = 60; // Number of seconds to count down

        var countdownTimer = setInterval(function () {//this is for the timer only 60s
            seconds--;

            document.getElementById("countdown").innerHTML = seconds + "s";

            if (seconds <= 0) {
                clearInterval(countdownTimer);
                document.getElementById("countdown").innerHTML = "Expired";
            }
        }, 1000);
    }

    //shuffles hints and tips
    var hintI = 1;
    function shuffleHint() {
        console.log("Print hints, ", hintI, " : ", hints[hintI]);
        if (hintI > originalTurns) {
            hintI = 1;
        }
        document.getElementById("hintPanel").innerHTML = hints[hintI];
        document.getElementById("controlPanel").style.display = 'flex';
        hintI += 1;
    }


    //used to handle game cycle/round
    function gameCycle() {

        if (turns <= 0) {
            
            return false;
        }

        if (userScore >= originalRounds) {
            changeHintPanel("You've won the game!")
            return true;
        } else if (computerScore >= originalRounds)  {
            changeHintPanel("You've loss the game!")
            console.log("You've loss the game")
        } else {
            apiCommunicator(category)
            rounds += 1; updateData()
            return false;
        }
    }

    //used to check if the word checked matches the correct word
    function wordChecker() {
        turns -= 1; updateData();

        console.log("my score: " + userScore)
        console.log("computer score: " + computerScore)
        var correctWord = sessionStorage.getItem('word')
        var guessedWord = document.getElementById('wordInput').value
        guessedWord = guessedWord.toLowerCase();
        guessedWord = guessedWord.trim();

        if (correctWord == guessedWord) { // word is guessed
            document.getElementById("hintPanel").innerHTML = "You've guessed the word!"
            hideControlPanel(false)

            addScore(true)

            if (gameCycle()) {
                return;
            }

        } else { // word not guessed

            if (turns <= 0) {
                changeHintPanel("You ran out of turns!")
                hideControlPanel(true)
                addScore(false)

                if (!gameCycle()) {
                    return;
                }
                turns = originalTurns; updateData();
            }

            shuffleHint()
        }

    }

    //change hint panel message
    function changeHintPanel(msg) {
        document.getElementById("hintPanel").innerHTML = msg;
    }

    function hideControlPanel(isHidden) {
        if (isHidden) {
            document.getElementById("controlPanel").style.display = 'none';
        } else {
            document.getElementById("controlPanel").style.display = 'flex';
        }
        
    }

    //saves the word into local storage.
    function saveWord(word) {
        console.log("Saving: ", word)
        sessionStorage.setItem("word", word);
    }

    function apiCommunicator(category) {
        console.log("Summary")
        var msg =
            `
                I want you to pick one word, not too simple, under the category of ${category}. 
                Give me hints of ${turns} separate simple sentences in bullet points for the word. 
                Do not use '-' in sentences or in words. 
                For example, instead of super-man, use superman.
                For example, instead of second-largest, use second largest.

                Strictly do not use the word or variations for the word when making the hints.

                Follow this as a sample response =
                Philippines 
                - It is an archipelagic country.
                - The country is in southeast asia.
                - The country is known for its beaches and kind people.
                - The population is around 100 million.
                - Some foods include sinigang and adobo.
                ;

                Make sure the tips are ${turns} bullet points.

                When stating the name of the word, do not include anything else such as periods, colons, or semicolons.

            `

        console.log(msg)

        var myHeaders = new Headers();
        myHeaders.append("Authorization", "Bearer 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");
        myHeaders.append("Content-Type", "application/json");

        var raw = JSON.stringify({
            "messages": [
                {
                    "role": "user",
                    "content": msg
                }
            ],
            "model": "gpt-3.5-turbo"
        });

        var requestOptions = {
            method: 'POST',
            headers: myHeaders,
            body: raw,
            redirect: 'follow'
        };

        fetch("https://api.openai.com/v1/chat/completions", requestOptions)
            .then(response => response.text())
            .then(result => {
                const res = JSON.parse(result)
                console.log(res.choices[0].message.content)

                var tempArr = res.choices[0].message.content.split("-")

                hints = tempArr;
                var wordToBeSaved = hints[0]
                shuffleHint();

                //to make sure the word does not appear
                var tempHints = [];
                for (var i = 1; i < hints.length; i++) {
                    tempHints.push(hints[i].replace(hints[0], "-blank-"))
                    tempHints.push(hints[i].replace((hints[0]  + 's'), "-blank-")) // removing word for example penguin and penguins (with added 's')
                }

                hints = tempHints;

                wordToBeSaved = wordToBeSaved.toLowerCase();
                wordToBeSaved = wordToBeSaved.replace(":", " ")
                wordToBeSaved = wordToBeSaved.trim()
                console.log("Sending: ", wordToBeSaved)
                saveWord(wordToBeSaved)
            }
            )
            .catch(error => {
                console.log('error', error)
                changeHintPanel("Too many requests! Please wait for awhile.")
            }
            );
    }

    initWordRound(category);

</script>

</html>